#cloud-config

timezone: "UTC"

hostname: "{{ hostname }}"
fqdn: "{{ fqdn }}"

package_update: true
package_upgrade: true
package_reboot_if_required: true

apt:
  sources:
    caddy:
      source: deb [arch=amd64] https://dl.cloudsmith.io/public/caddy/stable/deb/ubuntu $RELEASE main
      keyid: 65760C51EDEA2017CEA2CA15155B6D79CA56EA34
    docker.list:
      source: deb [arch=amd64] https://download.docker.com/linux/ubuntu $RELEASE stable
      keyid: 9DC858229FC7DD38854AE2D88D81803C0EBFCD88
    docker-ctop.list:
      source: deb [arch=amd64] http://packages.azlux.fr/debian/ stable main
      ## Note: wget -qO - https://azlux.fr/repo.gpg.key | gpg --show-keys
      keyid: 98B824A5FA7D3A10FDB225B7CA548A0A0312D8E6
    influxdb.list:
      source: deb [arch=amd64] https://repos.influxdata.com/ubuntu stable main
      keyid: 05CE15085FC09D18E99EFB22684A14CF2582E0C5

packages:
  - "ack"
  - "caddy"
  - "curl"
  - "docker-ce-cli"
  - "docker-ce"
  - "docker-ctop"
  - "htop"
  - "jq"
  - "mc"
  - "moreutils"
  - "net-tools"
  - "rsync"
  - "screen"
  - "telegraf"
  - "tmux"
  - "vim"

snap:
  commands:
    - ['install', 'yq']

system_info:
  default_user:
    name: "patron"
    lock_passwd: true
    gecos: "Teloshost Patron"

users:
  - "default"

ssh_import_id: [{{personnel|join(", ")}}]

write_files:
  - path: "/etc/teloshost"
    content: "cloud-init: true\n"

  - path: "/etc/telegraf/telegraf.conf"
    content: |
      [agent]
        interval = "10s"
        round_interval = true
        metric_batch_size = 1000
        metric_buffer_limit = 10000
        collection_jitter = "0s"
        flush_interval = "10s"
        flush_jitter = "0s"
        precision = ""
        debug = false
        quiet = false
        logfile = ""
        hostname = "{{ hostname }}"
        omit_hostname = false
      [[inputs.cpu]]
        percpu = true
        totalcpu = true
        collect_cpu_time = false
        report_active = false
      [[inputs.disk]]
        ignore_fs = ["tmpfs", "devtmpfs", "devfs", "overlay", "aufs", "squashfs"]
      [[inputs.diskio]]
      [[inputs.mem]]
      [[inputs.net]]
      [[inputs.processes]]
      [[inputs.swap]]
      [[inputs.system]]
      [[outputs.influxdb_v2]]
        urls = ["{{ monitor_url }}"]
        token = "{{ monitor_token }}"
        organization = "{{ monitor_organization }}"
        bucket = "{{ monitor_bucket }}"

runcmd:
  - ["usermod", "-aG", "docker", "patron"]
